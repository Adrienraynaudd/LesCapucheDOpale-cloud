# ==============================================================================
# GitHub Actions - Pipeline CI/CD pour Azure
# Les Capuches d'Opale - DÃ©ploiement automatique
# ==============================================================================

name: ðŸš€ Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement cible'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

env:
  AZURE_RESOURCE_GROUP: rg-capucheopale-${{ github.event.inputs.environment || 'dev' }}
  AZURE_LOCATION: francecentral
  NODE_VERSION: '20.x'
  PROJECT_NAME: capucheopale
  ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}

jobs:
  # ============================================================================
  # Job 1: Build Backend (NestJS)
  # ============================================================================
  build-backend:
    name: ðŸ”¨ Build Backend (NestJS)
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: back/package-lock.json

      - name: ðŸ“¥ Install dependencies
        working-directory: ./back
        run: npm ci

      - name: ðŸ”¨ Build NestJS
        working-directory: ./back
        run: npm run build

      - name: ðŸ“¦ Prepare deployment package
        working-directory: ./back
        run: |
          mkdir -p deploy
          cp -r dist deploy/
          cp package.json deploy/
          cp package-lock.json deploy/
          # Installer uniquement les dÃ©pendances de production
          cd deploy && npm ci --omit=dev

      - name: ðŸ“¤ Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: back/deploy/
          retention-days: 1

  # ============================================================================
  # Job 2: Build Frontend (Angular)
  # ============================================================================
  build-frontend:
    name: ðŸ”¨ Build Frontend (Angular)
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: front/package-lock.json

      - name: ðŸ“¥ Install dependencies
        working-directory: ./front
        run: npm ci

      - name: ðŸ”¨ Build Angular (ng build)
        working-directory: ./front
        run: npm run build -- --configuration production

      - name: ðŸ“¤ Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: front/dist/opal-project/browser/
          retention-days: 1

  # ============================================================================
  # Job 3: Deploy Infrastructure (Bicep)
  # ============================================================================
  deploy-infrastructure:
    name: ðŸ—ï¸ Deploy Infrastructure (Bicep)
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    outputs:
      backendAppName: ${{ steps.deploy.outputs.backendAppName }}
      frontendAppName: ${{ steps.deploy.outputs.frontendAppName }}
      backendUrl: ${{ steps.deploy.outputs.backendUrl }}
      frontendUrl: ${{ steps.deploy.outputs.frontendUrl }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸ“ Create Resource Group
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az group create \
              --name ${{ env.AZURE_RESOURCE_GROUP }} \
              --location ${{ env.AZURE_LOCATION }} \
              --tags Project=LesCapuchesDOpale Environment=${{ env.ENVIRONMENT }}

      - name: ðŸ—ï¸ Deploy Bicep Template
        id: deploy
        uses: azure/arm-deploy@v2
        with:
          resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
          template: ./infra/main.bicep
          parameters: >
            projectName=${{ env.PROJECT_NAME }}
            environment=${{ env.ENVIRONMENT }}
            location=${{ env.AZURE_LOCATION }}
            sqlAdminLogin=${{ secrets.SQL_ADMIN_LOGIN }}
            sqlAdminPassword=${{ secrets.SQL_ADMIN_PASSWORD }}
            jwtSecret=${{ secrets.JWT_SECRET }}
          failOnStdErr: false

      - name: ðŸ“‹ Output deployment info
        run: |
          echo "## ðŸŽ‰ Infrastructure dÃ©ployÃ©e!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Ressource | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ steps.deploy.outputs.frontendUrl }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend API | ${{ steps.deploy.outputs.backendUrl }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Job 4: Deploy Backend to App Service
  # ============================================================================
  deploy-backend:
    name: ðŸš€ Deploy Backend
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    
    steps:
      - name: ðŸ“¥ Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: ./backend-deploy

      - name: ðŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸ“¦ Create ZIP package
        run: |
          cd backend-deploy
          zip -r ../backend.zip .

      - name: ðŸš€ Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: api-${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}
          package: ./backend.zip

      - name: âœ… Backend deployed
        run: |
          echo "âœ… Backend dÃ©ployÃ© sur: https://api-${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}.azurewebsites.net"

  # ============================================================================
  # Job 5: Deploy Frontend to App Service
  # ============================================================================
  deploy-frontend:
    name: ðŸš€ Deploy Frontend
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    
    steps:
      - name: ðŸ“¥ Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./frontend-deploy

      - name: ðŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸ“¦ Create ZIP package
        run: |
          cd frontend-deploy
          zip -r ../frontend.zip .

      - name: ðŸš€ Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: web-${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}
          package: ./frontend.zip

      - name: âœ… Frontend deployed
        run: |
          echo "âœ… Frontend dÃ©ployÃ© sur: https://web-${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}.azurewebsites.net"

  # ============================================================================
  # Job 6: Summary
  # ============================================================================
  deployment-summary:
    name: ðŸ“‹ Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: success()
    
    steps:
      - name: ðŸ“‹ Generate Summary
        run: |
          echo "# ðŸŽ‰ DÃ©ploiement terminÃ© avec succÃ¨s!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŒ URLs de l'application" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Application | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ–¥ï¸ Frontend (Angular) | https://web-${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}.azurewebsites.net |" >> $GITHUB_STEP_SUMMARY
          echo "| âš™ï¸ Backend API (NestJS) | https://api-${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}.azurewebsites.net |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“š API Docs (Swagger) | https://api-${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}.azurewebsites.net/docs |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## â„¹ï¸ Informations" >> $GITHUB_STEP_SUMMARY
          echo "- **Environnement**: ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **RÃ©gion**: ${{ env.AZURE_LOCATION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Resource Group**: ${{ env.AZURE_RESOURCE_GROUP }}" >> $GITHUB_STEP_SUMMARY
