# =============================================================================
# CI/CD Pipeline - Les Capuches d'Opale (OPTIMISÃ‰)
# Pipeline rapide avec jobs parallÃ¨les
# =============================================================================

name: CI/CD Azure Deployment

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

env:
  AZURE_LOCATION: francecentral
  PROJECT_NAME: capuchesdopale

jobs:
  # ===========================================================================
  # JOBS PARALLÃˆLES: Tests + Build Docker en mÃªme temps
  # ===========================================================================
  
  # Job 1a: Tests Backend (parallÃ¨le)
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: back/package-lock.json
      - run: npm ci
        working-directory: ./back
      - run: npm run lint
        working-directory: ./back
        continue-on-error: true
      - run: npm run test
        working-directory: ./back
        continue-on-error: true

  # Job 1b: Tests Frontend (parallÃ¨le)
  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: front/package-lock.json
      - run: npm ci
        working-directory: ./front
      - run: npm run testCi
        working-directory: ./front
        continue-on-error: true

  # Job 1c: Build Docker Backend (parallÃ¨le)
  build-backend-image:
    name: Build Backend Image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/docker-login@v2
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/build-push-action@v6
        with:
          context: ./back
          file: ./back/Dockerfile
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/capuchesdopale-api:${{ github.sha }}
            ${{ secrets.ACR_LOGIN_SERVER }}/capuchesdopale-api:latest
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend

  # Job 1d: Build Docker Frontend (parallÃ¨le)
  build-frontend-image:
    name: Build Frontend Image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/docker-login@v2
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/build-push-action@v6
        with:
          context: ./front
          file: ./front/Dockerfile
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/capuchesdopale-web:${{ github.sha }}
            ${{ secrets.ACR_LOGIN_SERVER }}/capuchesdopale-web:latest
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend

  # Job 1e: Build Azure Functions (parallÃ¨le)
  build-functions:
    name: Build Azure Functions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: azure-functions/package-lock.json
      - run: npm ci
        working-directory: ./azure-functions
      - run: npm run build
        working-directory: ./azure-functions
      - uses: actions/upload-artifact@v4
        with:
          name: functions-build
          path: ./azure-functions
          retention-days: 1

  # ===========================================================================
  # JOB 2: DÃ©ploiement Infrastructure (attend les builds Docker)
  # ===========================================================================
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [build-backend-image, build-frontend-image]
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    outputs:
      backendFqdn: ${{ steps.get-urls.outputs.backendFqdn }}
      frontendFqdn: ${{ steps.get-urls.outputs.frontendFqdn }}
      resourceGroup: ${{ steps.set-vars.outputs.resourceGroup }}
      env: ${{ steps.set-vars.outputs.environment }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Set variables
        id: set-vars
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "resourceGroup=rg-${{ env.PROJECT_NAME }}-$ENV" >> $GITHUB_OUTPUT

      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Resource Group
        run: |
          az group create --name ${{ steps.set-vars.outputs.resourceGroup }} --location ${{ env.AZURE_LOCATION }} --tags project=${{ env.PROJECT_NAME }}

      - name: Deploy Bicep
        id: deploy-bicep
        uses: azure/arm-deploy@v2
        with:
          resourceGroupName: ${{ steps.set-vars.outputs.resourceGroup }}
          template: ./infra/main.bicep
          parameters: >
            projectName=${{ env.PROJECT_NAME }}
            environment=${{ steps.set-vars.outputs.environment }}
            location=${{ env.AZURE_LOCATION }}
            sqlAdminUsername=${{ secrets.SQL_ADMIN_USERNAME }}
            sqlAdminPassword=${{ secrets.SQL_ADMIN_PASSWORD }}
            jwtSecret=${{ secrets.JWT_SECRET }}
            jwtSecretAdmin=${{ secrets.JWT_SECRET_ADMIN }}
            containerRegistryUrl=${{ secrets.ACR_LOGIN_SERVER }}
            containerRegistryUsername=${{ secrets.ACR_USERNAME }}
            containerRegistryPassword=${{ secrets.ACR_PASSWORD }}
            backendImageTag=${{ github.sha }}
            frontendImageTag=${{ github.sha }}
          failOnStdErr: false

      - name: Get Container Apps URLs
        id: get-urls
        run: |
          ENV="${{ steps.set-vars.outputs.environment }}"
          RG="${{ steps.set-vars.outputs.resourceGroup }}"
          
          BACKEND_FQDN=$(az containerapp show \
            --name "ca-${{ env.PROJECT_NAME }}-${ENV}-api" \
            --resource-group "$RG" \
            --query "properties.configuration.ingress.fqdn" \
            --output tsv)
          
          FRONTEND_FQDN=$(az containerapp show \
            --name "ca-${{ env.PROJECT_NAME }}-${ENV}-web" \
            --resource-group "$RG" \
            --query "properties.configuration.ingress.fqdn" \
            --output tsv)
          
          echo "âœ… Backend: https://$BACKEND_FQDN"
          echo "âœ… Frontend: https://$FRONTEND_FQDN"
          
          echo "backendFqdn=$BACKEND_FQDN" >> $GITHUB_OUTPUT
          echo "frontendFqdn=$FRONTEND_FQDN" >> $GITHUB_OUTPUT

  # ===========================================================================
  # JOBS PARALLÃˆLES POST-INFRA: Function + DB Migration en mÃªme temps
  # ===========================================================================
  
  deploy-function:
    name: Deploy Function
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, build-functions]
    environment: ${{ github.event.inputs.environment || 'dev' }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: functions-build
          path: ./azure-functions
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - uses: Azure/functions-action@v1
        with:
          app-name: func-${{ env.PROJECT_NAME }}-${{ github.event.inputs.environment || 'dev' }}
          package: ./azure-functions

  database-migration:
    name: Database Migration
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    environment: ${{ github.event.inputs.environment || 'dev' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: back/package-lock.json
      - run: npm ci
        working-directory: ./back
      - name: Run Prisma
        working-directory: ./back
        env:
          DATABASE_URL: "sqlserver://sql-${{ env.PROJECT_NAME }}-${{ github.event.inputs.environment || 'dev' }}.database.windows.net:1433;database=guild-db;user=${{ secrets.SQL_ADMIN_USERNAME }};password=${{ secrets.SQL_ADMIN_PASSWORD }};encrypt=true;trustServerCertificate=false"
        run: |
          npx prisma generate
          npx prisma db push --accept-data-loss
        continue-on-error: true

  # ===========================================================================
  # JOB FINAL: Smoke Tests rapides
  # ===========================================================================
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-function, database-migration]
    if: always() && needs.deploy-infrastructure.result == 'success'
    
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get URLs and test endpoints
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          RG="rg-${{ env.PROJECT_NAME }}-$ENV"
          
          echo "ðŸ“ Resource Group: $RG"
          
          BACKEND=$(az containerapp show \
            --name "ca-${{ env.PROJECT_NAME }}-${ENV}-api" \
            --resource-group "$RG" \
            --query "properties.configuration.ingress.fqdn" \
            --output tsv)
          
          FRONTEND=$(az containerapp show \
            --name "ca-${{ env.PROJECT_NAME }}-${ENV}-web" \
            --resource-group "$RG" \
            --query "properties.configuration.ingress.fqdn" \
            --output tsv)
          
          echo "âœ… Backend URL: https://$BACKEND"
          echo "âœ… Frontend URL: https://$FRONTEND"
          
          sleep 30
          
          echo ""
          echo "ðŸ” Testing Backend..."
          for i in 1 2 3; do
            if curl -sf --connect-timeout 10 "https://$BACKEND" > /dev/null 2>&1; then
              echo "âœ… Backend OK"; break
            fi
            [ $i -lt 3 ] && echo "â³ Retry $i..." && sleep 15
          done
          
          echo "ðŸ” Testing Frontend..."
          for i in 1 2 3; do
            if curl -sf --connect-timeout 10 "https://$FRONTEND" > /dev/null 2>&1; then
              echo "âœ… Frontend OK"; break
            fi
            [ $i -lt 3 ] && echo "â³ Retry $i..." && sleep 15
          done

  # ===========================================================================
  # RÃ©sumÃ©
  # ===========================================================================
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, smoke-tests]
    if: always()
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Generate Summary
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          RG="rg-${{ env.PROJECT_NAME }}-$ENV"
          
          BACKEND=$(az containerapp show \
            --name "ca-${{ env.PROJECT_NAME }}-${ENV}-api" \
            --resource-group "$RG" \
            --query "properties.configuration.ingress.fqdn" \
            --output tsv 2>/dev/null || echo "N/A")
          
          FRONTEND=$(az containerapp show \
            --name "ca-${{ env.PROJECT_NAME }}-${ENV}-web" \
            --resource-group "$RG" \
            --query "properties.configuration.ingress.fqdn" \
            --output tsv 2>/dev/null || echo "N/A")
          
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | https://$FRONTEND |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | https://$BACKEND |" >> $GITHUB_STEP_SUMMARY
