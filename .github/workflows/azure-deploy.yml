# =============================================================================
# CI/CD Pipeline - Les Capuches d'Opale
# =============================================================================

name: CI/CD Azure Deployment

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'dev'
        type: choice
        options: [dev, prod]

env:
  AZURE_LOCATION: francecentral
  PROJECT_NAME: capuchesdopale

jobs:
  # ===========================================================================
  # PHASE 1: Tests + Builds (5 jobs en parallÃ¨le)
  # ===========================================================================
  
  test-backend:
    name: ðŸ§ª Test Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: back/package-lock.json
      - run: npm ci
        working-directory: ./back
      - run: npm run lint
        working-directory: ./back
        continue-on-error: true
      - run: npm run test
        working-directory: ./back
        continue-on-error: true

  test-frontend:
    name: ðŸ§ª Test Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: front/package-lock.json
      - run: npm ci
        working-directory: ./front
      - run: npm run testCi
        working-directory: ./front
        continue-on-error: true

  build-backend-image:
    name: ðŸ³ Build Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/docker-login@v2
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/build-push-action@v6
        with:
          context: ./back
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/capuchesdopale-api:${{ github.sha }}
            ${{ secrets.ACR_LOGIN_SERVER }}/capuchesdopale-api:latest
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend

  build-frontend-image:
    name: ðŸ³ Build Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/docker-login@v2
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/build-push-action@v6
        with:
          context: ./front
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/capuchesdopale-web:${{ github.sha }}
            ${{ secrets.ACR_LOGIN_SERVER }}/capuchesdopale-web:latest
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend

  build-functions:
    name: âš¡ Build Functions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: azure-functions/package-lock.json
      - run: npm ci && npm run build
        working-directory: ./azure-functions
      - uses: actions/upload-artifact@v4
        with:
          name: functions-build
          path: ./azure-functions
          retention-days: 1

  # ===========================================================================
  # PHASE 2: DÃ©ploiement Infrastructure Azure
  # ===========================================================================
  
  deploy-infrastructure:
    name: ðŸ—ï¸ Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [build-backend-image, build-frontend-image]
    environment: ${{ github.event.inputs.environment || 'dev' }}
    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Resource Group
        run: |
          az group create \
            --name rg-${{ env.PROJECT_NAME }}-${{ github.event.inputs.environment || 'dev' }} \
            --location ${{ env.AZURE_LOCATION }}

      - name: Deploy Bicep
        uses: azure/arm-deploy@v2
        with:
          resourceGroupName: rg-${{ env.PROJECT_NAME }}-${{ github.event.inputs.environment || 'dev' }}
          template: ./infra/main.bicep
          parameters: >
            projectName=${{ env.PROJECT_NAME }}
            environment=${{ github.event.inputs.environment || 'dev' }}
            location=${{ env.AZURE_LOCATION }}
            sqlAdminUsername=${{ secrets.SQL_ADMIN_USERNAME }}
            sqlAdminPassword=${{ secrets.SQL_ADMIN_PASSWORD }}
            jwtSecret=${{ secrets.JWT_SECRET }}
            jwtSecretAdmin=${{ secrets.JWT_SECRET_ADMIN }}
            containerRegistryUrl=${{ secrets.ACR_LOGIN_SERVER }}
            containerRegistryUsername=${{ secrets.ACR_USERNAME }}
            containerRegistryPassword=${{ secrets.ACR_PASSWORD }}
            backendImageTag=${{ github.sha }}
            frontendImageTag=${{ github.sha }}
          failOnStdErr: false

  # ===========================================================================
  # PHASE 3: DÃ©ploiements post-infra (2 jobs en parallÃ¨le)
  # ===========================================================================
  
  deploy-function:
    name: âš¡ Deploy Function
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, build-functions]
    environment: ${{ github.event.inputs.environment || 'dev' }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: functions-build
          path: ./azure-functions
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - uses: Azure/functions-action@v1
        with:
          app-name: func-${{ env.PROJECT_NAME }}-${{ github.event.inputs.environment || 'dev' }}
          package: ./azure-functions

  database-migration:
    name: ðŸ—„ï¸ Database Migration
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    environment: ${{ github.event.inputs.environment || 'dev' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: back/package-lock.json
      - run: npm ci
        working-directory: ./back
      - name: Run Prisma
        working-directory: ./back
        env:
          DATABASE_URL: "sqlserver://sql-${{ env.PROJECT_NAME }}-${{ github.event.inputs.environment || 'dev' }}.database.windows.net:1433;database=guild-db;user=${{ secrets.SQL_ADMIN_USERNAME }};password=${{ secrets.SQL_ADMIN_PASSWORD }};encrypt=true;trustServerCertificate=false"
        run: npx prisma generate && npx prisma db push --accept-data-loss
        continue-on-error: true

  # ===========================================================================
  # PHASE 4: Smoke Tests + RÃ©sumÃ©
  # ===========================================================================
  
  smoke-tests:
    name: ðŸ” Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-function, database-migration]
    if: always() && needs.deploy-infrastructure.result == 'success'
    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Test endpoints
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          RG="rg-${{ env.PROJECT_NAME }}-$ENV"
          
          # RÃ©cupÃ©rer les URLs
          BACKEND=$(az containerapp show --name "ca-${{ env.PROJECT_NAME }}-${ENV}-api" --resource-group "$RG" --query "properties.configuration.ingress.fqdn" -o tsv)
          FRONTEND=$(az containerapp show --name "ca-${{ env.PROJECT_NAME }}-${ENV}-web" --resource-group "$RG" --query "properties.configuration.ingress.fqdn" -o tsv)
          
          echo "ðŸ”— Backend: https://$BACKEND"
          echo "ðŸ”— Frontend: https://$FRONTEND"
          
          # Test avec retry intÃ©grÃ© Ã  curl (plus rapide que des boucles)
          echo ""
          echo "ðŸ§ª Testing Backend..."
          curl -sf --retry 5 --retry-delay 10 --retry-all-errors "https://$BACKEND/health" && echo "âœ… Backend OK" || echo "âš ï¸ Backend warming up"
          
          echo ""
          echo "ðŸ§ª Testing Frontend..."
          curl -sf --retry 5 --retry-delay 10 --retry-all-errors "https://$FRONTEND" > /dev/null && echo "âœ… Frontend OK" || echo "âš ï¸ Frontend warming up"
          
          # GÃ©nÃ©rer le rÃ©sumÃ©
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Frontend | https://$FRONTEND |" >> $GITHUB_STEP_SUMMARY
          echo "| âš™ï¸ Backend | https://$BACKEND/health |" >> $GITHUB_STEP_SUMMARY
